<html>
	<head>
		<link rel=StyleSheet href="css/style.css" type="text/css" media=screen>
		<script type="text/javascript" src="js/util.js"></script>
		<script>
			var background = chrome.extension.getBackgroundPage();
			
			function updateUsage() {
				var graphContainer = document.getElementById("graphContainer");
				var errorContainer = document.getElementById("errorContainer");
				var infoContainer = document.getElementById("infoContainer");
				errorContainer.style.display = "none";
				graphContainer.style.display = "block";
				infoContainer.style.display = "none";
				loading(true);
				background.updateUsage();
			}
			
			function showUsage(data) {
				var graphContainer = document.getElementById("graphContainer");
				var errorContainer = document.getElementById("errorContainer");
				var infoContainer = document.getElementById("infoContainer");
				if (!background.failureReason) {
					// Perform date calcs each load so they are correct against the time now.
					doDataDateCalc(data);
					
					// update graph
					var peak = document.getElementById("peak");
					var peakPercent = document.getElementById("peakPercent");
					peak.style.width = data.peakPct + "%";
					peakPercent.innerHTML = data.peakPct + "%";
					
					if (data.offpeakDl) {
						var offpeak = document.getElementById("offpeak");
						var offpeakPercent = document.getElementById("offpeakPercent");
						offpeak.style.width = data.offpeakPct + "%";
						offpeakPercent.innerHTML = data.offpeakPct + "%";
					}
					
					var timePercent = Math.round((data.totalDays - data.daysRemaining) / data.totalDays * 100);
					var arrow = document.getElementById("arrow");
					arrow.style.left = timePercent + "%";
					
					//update info table
					removeAllChildren(infoContainer);
					if (data.user) {
						addInfoRow(infoContainer, "User:", data.user);
					}
					if (data.plan) {
						addInfoRow(infoContainer, "Plan:", data.plan);
					}
					if (data.peakDl) {
						addInfoRow(infoContainer, "Peak DL:", data.peakDl + " / " + data.peakQuota + " " + data.unit + " (" + data.peakPct + "%)");
					}
					if (data.offpeakDl) {
						addInfoRow(infoContainer, "Off-Peak DL:", data.offpeakDl + " / " + data.offpeakQuota + " " + data.unit + " (" + data.offpeakPct + "%)");
					}
					if (data.upload) {
						addInfoRow(infoContainer, "Upload:", data.upload + " / " + data.uploadQuota + " " + data.unit + " (" + data.uploadPct + "%)");
					}
					if (data.miscUsage) {
						addInfoRow(infoContainer, data.miscName + ":", data.miscUsage + " / " + data.miscQuota + " " + data.unit + " (" + data.miscPct + "%)");
					}
					addInfoRow(infoContainer, "Last Reset:", data.lastReset);
					addInfoRow(infoContainer, "Time Remaining:", data.daysRemaining + "d " + data.hoursRemaining + "h");
					if (data.peakDl) {
						addInfoRow(infoContainer, "Peak Remaining:", data.peakPerDayRemaining + " " + data.unit + "/d");
					}
					if (data.offpeakDl) {
						addInfoRow(infoContainer, "Off-Peak Remaining:", data.offpeakPerDayRemaining + " " + data.unit + "/d");
					}
					
					errorContainer.style.display = "none";
					graphContainer.style.display = "block";
					infoContainer.style.display = "block";
				} else {
					errorContainer.innerHTML = "<b>ERROR:</b> " + background.failureReason;
					errorContainer.style.display = "block";
					graphContainer.style.display = "none";
					infoContainer.style.display = "none";
				}
				loading(false);
			}

			function loading(mask) {
				var loading = document.getElementById("loading");
				if (mask) {
					loading.style.display = "block";
				} else {
					loading.style.display = "none";
				}
			}

			function addInfoRow(container, label, value) {
				var infoRow = document.createElement("div");
				infoRow.className = "infoRow";

				var infoLabel = document.createElement("div");
				infoLabel.className = "infoLabel";
				infoLabel.innerHTML = label;
				infoRow.appendChild(infoLabel);

				var infoValue = document.createElement("div");
				infoValue.className = "infoValue";
				infoValue.innerHTML = value;
				infoRow.appendChild(infoValue);

				container.appendChild(infoRow);
				/*
				<div class="infoRow">
					<div class="infoLabel">User:</div>
					<div id="user" class="infoValue"></div>		
				</div>
				*/
			}
		</script>
	</head>
	<body onload="showUsage(loadObject('data'))">
		<div id="loading" class="loading">
			<div id="loadingMask" class="loadingMask"></div>
			<div id="loadingMsg" class="loadingMsg">Loading...</div>
		</div>
		<div class="row">
			<div id="graphContainer" class="graphContainer">
				<div id="graph" class="graph">
					<div id="peak" class="peak"></div>
					<div id="offpeak" class="offpeak"></div>
					<div id="arrow" class="arrow"></div>
					<div id="peakPercent" class="percent"></div>
					<div id="offpeakPercent" class="percent"></div>				
				</div>
			</div>
			<div id="errorContainer" class="errorContainer"> 
			</div>
			<div class="refresh" onClick="javascript:updateUsage();" title="Refresh"></div>
		</div>
		<div class="row">
			<div id="infoContainer" class="infoContainer">
			</div>
		</div>
	</body>
</html>