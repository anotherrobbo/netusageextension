<html>
	<head>
		<script type="text/javascript" src="js/util.js"></script>
		<script>
			var failureReason;
			
			function updateUsage() {
				loading();
				var provider = localStorage["provider"];
				var providerLoaded = loadProvider(provider);
				if (providerLoaded) {
					details = getConnectionDetails();
					loadData(details);
				}
			}
			
			function loadData(details) {
				if (details.loaded) {
					var req = new XMLHttpRequest();
					req.open(
						details.action
						,details.url
						//,"usage.xml"
						,true
					);
					req.onload = function() {
						//alert("load data: " + req.status);
						if (req.status == 200) {
							var data = processData(req.responseXML);
							storeObject("data", data);
							success(data);
						} else {
							fail("Failed to get usage data, please check settings in Options");
						}
					}
					req.onabort = function() {
						fail("Failed to get usage data, please check settings in Options");
					}					
					req.send(null);
					
					setTimeout(function() {
						if (req.readyState != 4 || req.status != 200) {
							//alert(req.readyState);// + " " + req.status);
							req.abort();
						}
					}, 5000);
				} else {
					fail("Failed to load required settings, please set up in Options");
				}
			}
			
			function loadProvider(provider) {
				var newelement = createProvider(provider);
				var targetelement = "script";
				var targetattr = "src";
				var allsuspects = document.getElementsByTagName(targetelement);
				for (var i = allsuspects.length - 1; i >= 0; i--) {
					if (allsuspects[i] && allsuspects[i].getAttribute(targetattr)!=null && allsuspects[i].getAttribute(targetattr).indexOf("isp_") != -1) {
						if (allsuspects[i].getAttribute(targetattr) == "js/isp_" + provider + ".js") {
							return true;
						} else {
							allsuspects[i].parentNode.replaceChild(newelement, allsuspects[i])
							return false;
						}
					}
				}
				document.getElementsByTagName("head")[0].appendChild(newelement);
				return false;
			}
			
			function createProvider(provider) {
				var providerJs = document.createElement('script');
				providerJs.setAttribute("type","text/javascript");
				providerJs.setAttribute("src", "js/isp_" + provider + ".js");
				providerJs.onload = function() {
					var details = getConnectionDetails();//localStorage["connectionDetails"];
					loadData(details);
				}
				return providerJs;
			}
			
			function loading() {
				chrome.browserAction.setBadgeText({text:"..."});
				chrome.browserAction.setBadgeBackgroundColor({color:[0,0,255,255]});
				chrome.browserAction.setIcon({path:"images/icon19.png"});
				chrome.browserAction.setTitle({title:"Loading..."});
			}
			
			function success(data) {
				failureReason = undefined;
				chrome.browserAction.setBadgeText({text:data.peakPercent + "%"});
				if (data.onpeakPercent >= 90) {
					chrome.browserAction.setBadgeBackgroundColor({color:[255,0,0,255]});
				} else {
					chrome.browserAction.setBadgeBackgroundColor({color:[0,128,0,255]});
				}
				chrome.browserAction.setIcon({path:"images/icon19.png"});
				chrome.browserAction.setTitle({title:
					  "Peak: " + data.peakDl + "/" + data.quota + data.unit + " (" + data.peakPercent + "%)"
					+ "\nOffPeak: " + data.offpeakDl + "/" + data.quota + data.unit + " (" + data.offpeakPercent + "%)"
					+ "\nClick for more details"
					});
				updateViews(data);
			}
			
			function fail(reason) {
				//alert('fail');
				failureReason = reason;
				chrome.browserAction.setBadgeText({text:"?"});
				chrome.browserAction.setBadgeBackgroundColor({color:[128,128,128,255]});
				chrome.browserAction.setIcon({path:"images/icon19_m.png"});
				chrome.browserAction.setTitle({title:"Please check Options"});
				updateViews(undefined);
			}
			
			function updateViews(data) {
				var views = chrome.extension.getViews();
				for (var i = 0, view; view = views[i]; i++) {
					if (view.location.pathname == "/usage.html") {
						//alert("Showing Usage");
						view.showUsage(data);
					}
				}
			}
		</script>
	</head>
	<body onload="updateUsage()"></body>
</html>