<html>
	<head>
		<script type="text/javascript" src="js/util.js"></script>
		<script>
			var failureReason;
			var updateId;

			function updateUsage() {
				cancelScheduledUpdate();
				doUpdate();
				if (localStorage["refresh"] && localStorage["refresh"] > 0) {
					updateId = setTimeout(function() {updateUsage();}, localStorage["refresh"]);
				}
			}

			function cancelScheduledUpdate() {
				if (updateId) {
					clearTimeout(updateId);
					updateId = undefined;
				}
			}

			function doUpdate() {
				console.log("doUpdate: " + new Date());
				loading();
				var isp = localStorage["isp"];
				if (!isp) {
					fail("Failed to load required settings<br>ISP details missing<br>Please set up in Options");
					return;
				}
				var ispLoaded = loadISP(isp, function() {
					var details = getConnectionDetails();
					loadData(details);
				});
				if (ispLoaded) {
					var details = getConnectionDetails();
					loadData(details);
				}
			}
			
			function loadData(details) {
				if (details.loaded) {
					var req = new XMLHttpRequest();

					timeoutId = setTimeout(function() {
						if (req.readyState != 4 || req.status != 200) {
							req.abort();
							fail("Failed to get usage data<br>Request timed out<br>Please check settings in Options");
						}
					}, 5000);
					
					req.open(
						details.action
						,details.url
						,true
					);
					req.onload = function() {
						console.log("onload, req.status=" + req.status);
						if (timeoutId) {
							clearTimeout(timeoutId);
						}
						if (req.status == 200 || (debug && req.status == 0)) {
							var data = processData(req.responseXML, req.responseText);
							if (data.loaded) {
								storeObject("data", data);
								success(data);
							} else {
								fail("Failed to get usage data<br>Invalid usage data returned from server<br>" + data.error + "<br>Please check settings in Options");
							}
						} else {
							fail("Failed to get usage data<br>Request returned status of " + req.status + "<br>Please check settings in Options");
						}
					}
					req.send(null);
				} else {
					fail("Failed to load required settings<br>" + details.error + "<br>Please set up in Options");
				}
			}
			
			function loading() {
				chrome.browserAction.setBadgeText({text:"..."});
				chrome.browserAction.setBadgeBackgroundColor({color:[0,0,255,255]});
				chrome.browserAction.setIcon({path:"images/icon19.png"});
				chrome.browserAction.setTitle({title:"Loading..."});
			}
			
			function success(data) {
				failureReason = undefined;
				chrome.browserAction.setBadgeText({text:data.peakPct + "%"});
				if (data.peakPct >= 90) {
					chrome.browserAction.setBadgeBackgroundColor({color:[255,0,0,255]});
				} else {
					chrome.browserAction.setBadgeBackgroundColor({color:[0,128,0,255]});
				}
				chrome.browserAction.setIcon({path:"images/icon19.png"});
				var title = "Peak: " + data.peakDl + "/" + data.peakQuota + data.unit + " (" + data.peakPct + "%)";
				if (data.offpeakDl) {
					title += + "\nOffPeak: " + data.offpeakDl + "/" + data.offpeakQuota + data.unit + " (" + data.offpeakPct + "%)";
				}
				title += "\nClick for more details"
				chrome.browserAction.setTitle({title:title});
				updateViews(data);
			}
			
			function fail(reason) {
				console.log("fail: " + reason);
				failureReason = reason;
				chrome.browserAction.setBadgeText({text:"?"});
				chrome.browserAction.setBadgeBackgroundColor({color:[128,128,128,255]});
				chrome.browserAction.setIcon({path:"images/icon19_m.png"});
				chrome.browserAction.setTitle({title:"Please check Options"});
				updateViews(undefined);
			}
			
			function updateViews(data) {
				var views = chrome.extension.getViews();
				for (var i = 0, view; view = views[i]; i++) {
					if (view.location.pathname == "/usage.html") {
						view.showUsage(data);
					}
				}
			}
		</script>
	</head>
	<body onload="updateUsage()"></body>
</html>